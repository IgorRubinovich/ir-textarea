<!doctype html>
<!--
@license
Copyright (c) 2015 Igor Rubinovich <igor.rubinovich@gmail.com>. All rights reserved.
This code may only be used under the MIT license found at http://opensource.org/licenses/MIT
-->
<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="../../polymer/polymer.html">

  <link rel="import" href="../../ir-gallery/ir-gallery.html">

  <script src="../modules/utils.js"></script>
  <script src="../modules/extract.js"></script>
  <script src="../modules/paste.js"></script>
  <script src="../modules/caretRules.js"></script>
  <script src="../modules/caretNavigator.js"></script>


  <style>
	body { background-color : #eaeaea; padding : 25px; font-family : sans-serif; padding : 5px; }
	div { border : 1px solid lightblue; margin-top : 10px; margin-bottom : 10px; padding : 5px; box-shadow : 2px 2px 2px lightgrey; }
	button { border-radius : 3px; min-width : 60px; height : 30px; font-size : 12px }
	.caret { display : inline-block; height : 1em; border : #fafafa 1px solid; padding : 4px; background : red; color : white; font-family : Arial; font-size : 10px }
	span.paragraph { min-height : 5px;display : block; border : blue 1px solid }
	#aux1, #aux2 { font-size : .8em; font-family : Arial}
	#htmlModified { display : inline-block; position : relative; width : 10px; height : 10px; border-radius : 20px; background-color : green }
	#htmlModified.yes { background-color : red }
	#log { width : 100%; font-size : .8em; font-family : Arial}
	button { margin : 5px; }
	#editor { 
		box-shadow : 0 0 3px lightblue; margin : 0 0 25px 0; padding : 25px; background-color : white 
		white-space: pre-wrap;       /* css-3 */
		white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
		white-space: -pre-wrap;      /* Opera 4-6 */
		white-space: -o-pre-wrap;    /* Opera 7 */
		word-wrap: break-word;       /* Internet Explorer 5.5+ */
	}
	#elclone { max-height : 100px; overflow : hidden; }
  </style>  
</head>

<script>  
	var utils = ir.textarea.utils;
	var extract = ir.textarea.extract;
	var paste = ir.textarea.paste;

	var editor;
	var original, aux1, aux2, startAtPair, htmlModified, positionsPairs;

	window.addEventListener('DOMContentLoaded', function () {
		editor = document.getElementById('editor');
		aux1 = document.getElementById('aux1');
		aux2 = document.getElementById('aux2');
		startAtPair = document.getElementById('startAtPair');
		htmlModified = document.getElementById('htmlModified');
	});

	function log(stuff)
	{
		document.querySelector('#log').innerHTML = stuff.toString()
	}
	
	function testHasContent(dir) {
		var r = utils.getSelectionRange();
		log("posToContainerEdgeHasContent: " + utils.posToContainerEdgeHasContent({ container : r.startContainer, offset : r.startOffset }, dir, editor))
	}

	function testExtract(del) {
		var r = utils.getSelectionRange();
		html = extract.extractContents({ container : r.sc, offset : r.so }, { container : r.ec, offset : r.eo }, { top : editor, delete : del, splitRoot : editor } )
		html = innerHTML(html, true)
		log(html)
	}
	
	

	function resetLoop() {
		if(original)
			editor.innerHTML = original
			
		aux1.innerHTML = ""
		aux2.innerHTML = ""
		
	}
	
	function getPositionsPairs(sync) {
		// run over all symmetrically unique pairs of startPosition, endPosition for all text nodes in editor
		// then cut and paste for each selection (tens of thousands of points!)
		// the test is successful if the document remains intact
		
		var positions, positionsPairs;

		positions = 
		utils
		.visitNodes(editor, function(n, meta, prevRes) {
			if((n.nodeType == 3  || !utils.canHaveChildren(n)) && utils.isInLightDom(n, editor))
				prevRes.push(n);
				
			return prevRes;

		}, { skipRoot : true }, {}, [])
		.reduce(function(prev, curr) {
			var i, pos;
			if(utils.isTransitionalElement(curr.parentNode))
				return prev; // there's no point to fix this

			if(curr.nodeType == 1)
			{
				pos = utils.posToCoordinatesPos({ container : curr, offset : 0}, editor);
				pos.originalContainer = curr;
				prev.push(pos);
			}
			else
			{
				pos = utils.posToCoordinatesPos({ container : curr, offset : 0}, editor);
				pos = utils.posToCoordinatesPos({ container : curr, offset : curr.textContent.length}, editor);
				if(curr.textContent.length > 1)
					pos = utils.posToCoordinatesPos({ container : curr, offset : 1}, editor);
				if(curr.textContent.length > 2)
					pos = utils.posToCoordinatesPos({ container : curr, offset : curr.textContent.length - 1}, editor);
				//pos.originalContainer = curr;
				prev.push(pos);
				
			}
			/*for(i = 0; i < curr.textContent.length; i++)
			{
				pos = utils.posToCoordinatesPos({ container : curr, offset : i}, editor);
				pos.originalContainer = curr;
				prev.push(pos);
			}*/				
			return prev;
		}, []);
		
		positionsPairs = 
		positions
		.reduce(function(coll, left, i) {
			positions
			.slice(i + 1, positions.length)
			.reduce(function(coll, right) {
				coll.push({ startPosition : left, endPosition : right});
				return coll;
			}, coll);
			return coll;
		}, []);
		
		return positionsPairs;
	}
	
	function oneStep()
	{
	}
	
	function testLoop (sync, onlyone) {
		
		if(!positionsPairs)
			positionsPairs = getPositionsPairs();
		
		
		var i = startAtPair.value || 0;
		
		if(onlyone && original)
			editor.innerHTML = original;

		if(!original)
			 original = Polymer.dom(editor).innerHTML; //innerHTML(editor);
		
		var goAsync = function(positionsPairs, i) {
			requestAnimationFrame(function(positionsPairs, i) { 
				if(i < positionsPairs.length - 1)
				{
					i++;
					go(positionsPairs, i);
					goAsync(positionsPairs, i);
				}
			}.bind(null, positionsPairs, i));
		}

		var go = function(positionsPairs, i, sync) {	
				var err;

				log((i+1) + " of " + positionsPairs.length + "\n" + Math.floor(10000* (i+1)/positionsPairs.length)/100 + "% complete")
				startAtPair.value = i;
				
				try {
					_testLoopPair(positionsPairs[i], i);
				}
				catch(e)
				{
					err = e;
				}			
				if(err)
				{
					console.error("failed at pair " + i, positionsPairs[i])
					console.error(i, positionsPairs[i])
					console.error("err", err);
					console.error(err.stack)
					throw err;
				}
				
				if(original != Polymer.dom(editor).innerHTML)
				{
					editor.innerHTML = original;
					htmlModified.classList.add('yes')
				}
				else
					htmlModified.classList.remove('yes')
		};
		
		function showDiff(a, b) { var i; for(i=0;i<a.length && a[i] == b[i]; i++) ; if(a[i]!=b[i]) console.log(a.slice(i - 10, i + 10, b.slice(i-10, i+10)))}
	
		if(onlyone)
			return go(positionsPairs, i);
	
		if(sync)
			while(i < positionsPairs.length - 1)
				go(positionsPairs, i++, true);
		else
			goAsync(positionsPairs, i);
	}
	
	function _testLoopPair(pair, i) {
		var s = utils.coordinatesPosToPos(pair.startPosition, editor), 
			e = utils.coordinatesPosToPos(pair.endPosition, editor);
	
		var extractResTest = extract.extractContents(s, e, { top : editor, delete : false, splitRoot : editor } );
		var extractRes = extract.extractContents(s, e, { top : editor, delete : true, splitRoot : editor } );

		s = utils.coordinatesPosToPos(pair.startPosition, editor);
		while(!s.container)
		{
			pair.startPosition.container.pop();
			pair.offset = 0;
			s = utils.coordinatesPosToPos(pair.startPosition, editor);
		}
		if(s.container.nodeType == 3 && s.offset > s.container.length)
			s.offset = s.container.length;

		aux2.innerHTML = aux1.innerHTML
		aux1.innerHTML = innerHTML(extractRes)
		
		paste.pasteHtmlAtPosWithParagraphs(extractRes, s, { top : editor });
	}
	
	
	function innerHTML(el, noescape) {
		var r = "";
		if(el instanceof DocumentFragment)
			for(var i = 0; i < el.childNodes.length; i++)
				r += el.childNodes[i].nodeType == 3 ? el.childNodes[i].textContent : utils.recursiveOuterHTML(el.childNodes[i]);
		else
			r =  utils.recursiveOuterHTML(el);
		
		if(!noescape)
			r = r.replace(/\</g, '&lt;').replace(/\>/g, '&gt;')
		
		return r;
		
	}
	
	function testPaste(_html) {
		var r = utils.getSelectionRange();
		if(!_html)
			_html = html;
			
		paste.pasteHtmlAtPosWithParagraphs(_html, { container : r.sc, offset : r.so }, { top : editor });
		
		//console.log(extract.extractContents({ container : r.sc, offset : r.so }, { container : r.ec, offset : r.eo }, { top : editor, delete : del, splitRoot : editor } ))
	}
	
	function testCutAndPaste() {
		r = utils.getSelectionRange();
		testExtract(true);
		utils.setCaretAt(r.endContainer, r.endOffset);
		testPaste();
		
	}

	var logspace = document.querySelector('#logspace');


</script>


<body>
	<div>
		Hascontent:
		<button onclick="testHasContent('backward')">&lt;hascontent</button>
		<button onclick="testHasContent('forward')">hascontent&gt;</button>
	</div>
	<div>
		Basic:
		<button onclick="testExtract(true)">cut</button>
		<button onclick="testExtract(false)">copy</button>
		<button onclick="testPaste()">paste</button>
		<button onclick="testCutAndPaste(false)">cut + paste</button>
	</div>
	<div>
		Hanging paste:
		<button onclick="testPaste('hanging<span class=\'paragraph\'>- hello paste -</span>')">paste (hanging start)</button>
		<button onclick="testPaste('<span class=\'paragraph\'>- paste - no hanging</span><span class=\'paragraph\'>just paragraphs -</span>')">paste (no hanging)</button>
		<button onclick="testPaste('<span class=\'paragraph\'>- hello paste -</span>hanging')">paste (hanging end)</button>
	</div>
	<div>
		Inline paste:
		<button onclick="testPaste('<i>some italic</i>')">paste italic</button>
		<button onclick="testPaste('<b>some bold</b>')">paste bold</button>
		<button onclick="testPaste('<u>some underline</u>')">paste underline</button>
	</div>
	<div>
		Copy/paste full loop:
		<button onclick="testLoop(true)">sync</button>
		<button onclick="testLoop()">async</button>
		<button onclick="resetLoop()">reset</button>
		<button onclick="testLoop(true, true)">test single pos</button>
		start at pair: <input id="startAtPair" value="" size=4>
	</div>
	<div>
		html modified: <span id="htmlModified"></span>
	</div>
	<div>
		log <textarea id="log"></textarea>
	</div>
	aux1 <div id="aux1"></div>
	aux2 <div id="aux2"></div>
	<div 
		id="editor" 
		contenteditable
	>some normal text, an <i>italic block</i><b>and a bold block</b> enter a bar<ul><li>list item 1</li><li>list item 2</li><li>list item 3</li></ul><table border>
			<tr>
				<td>table inside</td>
				<td>paragraph</td>
			</tr>			
			<tr>
				<td>two</td>
				<td>rows</td>
			</tr>
		</table><span class="paragraph"><table border>
			<tr>
				<td>table inside</td>
				<td>paragraph</td>
			</tr>			
			<tr>
				<td>two</td>
				<td>rows</td>
			</tr>
		</table>
	</span><span class="paragraph">paragraph 01 a b c d e f g</span><span class="paragraph">paragraph 02 a b c d e f g</span><span class="paragraph">paragraph 03 a b c d e f g</span><span class="paragraph">paragraph 04 a b c d e f g</span><span class="paragraph">paragraph 05 a b c d e f g</span>01 02 03 <i>04 05 06</i> 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30
a couple empty paragraphs<span class="paragraph"></span><span class="paragraph"></span><span class="paragraph">1. two consecutive</span><span class="paragraph">2. hello<br><br><br><br><br><br><br><br><br></span><span class="paragraph">3. paragraphs with empty paragraph between</span><span class="paragraph">4. two consecutive</span><span class="paragraph">5. paragraphs</span>
	<ir-gallery id="1" contenteditable="false"><img src="http://i00.i.aliimg.com/wsphoto/v0/1855197662_1/2015-%D7%A0%D7%99%D7%95-%D7%97%D7%99%D7%95%D7%AA-%D7%9E%D7%97%D7%9E%D7%93-%D7%9B%D7%9C%D7%91-%D7%A6%D7%A2%D7%A6%D7%95%D7%A2-%D7%9B%D7%93%D7%95%D7%A8-jin-mao-%D7%91%D7%99%D7%9E%D7%91%D7%95-%D7%93%D7%95%D7%91%D7%95%D7%9F-%D7%A1%D7%9E%D7%95%D7%99%D7%93-%D7%9E%D7%95%D7%A6%D7%A8%D7%99%D7%9D-%D7%9C%D7%9B%D7%9C%D7%91%D7%99%D7%9D-%D7%92%D7%95%D7%A8-%D7%A7%D7%98%D7%9F.jpg" style="display: inline-block; position: relative; width: 247px; height: 186.859px; transform: translate(0px, 0px);" width="247" height="186.859375"></ir-gallery><span class="paragraph">a paragraph with a CE just before it no space between</span>

	
	<span class="paragraph">01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30</span>
	<ir-gallery id="2" contenteditable="false"><img src="http://i00.i.aliimg.com/wsphoto/v0/1855197662_1/2015-%D7%A0%D7%99%D7%95-%D7%97%D7%99%D7%95%D7%AA-%D7%9E%D7%97%D7%9E%D7%93-%D7%9B%D7%9C%D7%91-%D7%A6%D7%A2%D7%A6%D7%95%D7%A2-%D7%9B%D7%93%D7%95%D7%A8-jin-mao-%D7%91%D7%99%D7%9E%D7%91%D7%95-%D7%93%D7%95%D7%91%D7%95%D7%9F-%D7%A1%D7%9E%D7%95%D7%99%D7%93-%D7%9E%D7%95%D7%A6%D7%A8%D7%99%D7%9D-%D7%9C%D7%9B%D7%9C%D7%91%D7%99%D7%9D-%D7%92%D7%95%D7%A8-%D7%A7%D7%98%D7%9F.jpg" style="display: inline-block; position: relative; width: 247px; height: 186.859px; transform: translate(0px, 0px);" width="247" height="186.859375"></ir-gallery>
		Some text <b><i>italic in bold</i>some bold</b> without paragraph ending with two brs<br><br><ir-gallery id="3" contenteditable="false" theme="blackfriday" style="display: inline-block;"><div class="caption-wrapper"><img src="https://storage17.tunefiles.com/files/thumbs/2014/07/26/1406397346ad30f-original-1.jpg" style="display: inline-block; position: relative; width: 218px; height: 166.313px; transform: translate(0px, 0px);" width="218" height="166.3125"><div class="caption" contenteditable="true">hi caption</div></div></ir-gallery><ir-gallery id="4" contenteditable="false"><img src="http://i00.i.aliimg.com/wsphoto/v0/1855197662_1/2015-%D7%A0%D7%99%D7%95-%D7%97%D7%99%D7%95%D7%AA-%D7%9E%D7%97%D7%9E%D7%93-%D7%9B%D7%9C%D7%91-%D7%A6%D7%A2%D7%A6%D7%95%D7%A2-%D7%9B%D7%93%D7%95%D7%A8-jin-mao-%D7%91%D7%99%D7%9E%D7%91%D7%95-%D7%93%D7%95%D7%91%D7%95%D7%9F-%D7%A1%D7%9E%D7%95%D7%99%D7%93-%D7%9E%D7%95%D7%A6%D7%A8%D7%99%D7%9D-%D7%9C%D7%9B%D7%9C%D7%91%D7%99%D7%9D-%D7%92%D7%95%D7%A8-%D7%A7%D7%98%D7%9F.jpg" style="display: inline-block; position: relative; width: 247px; height: 186.859px; transform: translate(0px, 0px);" width="247" height="186.859375"></ir-gallery>
		<span class="paragraph">a short paragraph a short paragraph a short paragraph <b>some bold in a short paragraph <i> some italic in bold in a short paragraph </i></b>a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph </span>
		<span class="paragraph"><ir-gallery contenteditable="false"><img src="http://i00.i.aliimg.com/wsphoto/v0/1855197662_1/2015-%D7%A0%D7%99%D7%95-%D7%97%D7%99%D7%95%D7%AA-%D7%9E%D7%97%D7%9E%D7%93-%D7%9B%D7%9C%D7%91-%D7%A6%D7%A2%D7%A6%D7%95%D7%A2-%D7%9B%D7%93%D7%95%D7%A8-jin-mao-%D7%91%D7%99%D7%9E%D7%91%D7%95-%D7%93%D7%95%D7%91%D7%95%D7%9F-%D7%A1%D7%9E%D7%95%D7%99%D7%93-%D7%9E%D7%95%D7%A6%D7%A8%D7%99%D7%9D-%D7%9C%D7%9B%D7%9C%D7%91%D7%99%D7%9D-%D7%92%D7%95%D7%A8-%D7%A7%D7%98%D7%9F.jpg" style="display: inline-block; position: relative; width: 247px; height: 186.859px; transform: translate(0px, 0px);" width="247" height="186.859375"></ir-gallery> a gallery immediately under a paragraph</span>

	<table border>
		<tr>
			<td>some</td>
			<td>tabled</td>
		</tr>
		<tr>
			<td>data</td>
			<td>here</td>
		</tr>
	</table>
	
	<span class="paragraph"><table border>
			<tr>
				<td>table inside</td>
				<td>paragraph</td>
			</tr>
		</table>
	</span>

	</div>

	
</body>

  
</html>
