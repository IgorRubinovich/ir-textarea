<!doctype html>
<!--
@license
Copyright (c) 2015 Igor Rubinovich <igor.rubinovich@gmail.com>. All rights reserved.
This code may only be used under the MIT license found at http://opensource.org/licenses/MIT
-->
<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="../../polymer/polymer.html">

  <link rel="import" href="../../ir-gallery/ir-gallery.html">

  <script src="../modules/utils.js"></script>
  <script src="../modules/extract.js"></script>
  <script src="../modules/paste.js"></script>
  <script src="../modules/caretRules.js"></script>
  <script src="../modules/caretNavigator.js"></script>


  <style>
	body { background-color : #eaeaea; padding : 25px }
	button { border-radius : 3px; min-width : 60px; height : 30px; font-size : 12px }
	.caret { display : inline-block; height : 1em; border : #fafafa 1px solid; padding : 4px; background : red; color : white; font-family : Arial; font-size : 10px }
	span.paragraph { display : block; border : blue 1px solid }
	#editor { 
		box-shadow : 0 0 3px lightblue; margin : 0 0 25px 0; padding : 25px; background-color : white 
		white-space: pre-wrap;       /* css-3 */
		white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
		white-space: -pre-wrap;      /* Opera 4-6 */
		white-space: -o-pre-wrap;    /* Opera 7 */
		word-wrap: break-word;       /* Internet Explorer 5.5+ */
	}
	#elclone { max-height : 100px; overflow : hidden; }
  </style>  
</head>

<script>  
	var utils = ir.textarea.utils;
	var extract = ir.textarea.extract;
	var paste = ir.textarea.paste;

	var editor; 
	
	window.addEventListener('DOMContentLoaded', function () {
		editor = document.getElementById('editor');
	});

	function log(stuff)
	{
		document.querySelector('#log').innerHTML = stuff.toString()
	}
	
	function testHasContent(dir) {
		var r = utils.getSelectionRange();
		console.log(utils.posToContainerEdgeHasContent({ container : r.startContainer, offset : r.startOffset }, dir, editor))
	}

	function testExtract(del) {
		var r = utils.getSelectionRange();
		var extractres = extract.extractContents({ container : r.sc, offset : r.so }, { container : r.ec, offset : r.eo }, { top : editor, delete : del, splitRoot : editor } )
		log(extractres.nodeType == 3 ? extractres.textContent : Polymer.dom(extractres).innerHTML)
	}
	
	function testLoop(html) {
		// run over all symmetrically unique pairs of startPosition, endPosition for all text nodes in editor
		// then cut and paste for each selection (tens of thousands of points!)
		// the test is successful if the document remains intact
		
		var positions, positionsPairs;

		positions = 
		utils
		.visitNodes(editor, function(n, meta, prevRes) {
			if(n.nodeType == 3 && utils.isInLightDom(n, editor))
				prevRes.push(n);
				
			return prevRes;

		}, {}, {}, [])
		.reduce(function(prev, curr) {
			var i, pos;
			for(i = 0; i < curr.length; i++)
			{
				pos = utils.posToCoorinatesPos({ container : curr, offset : i}, editor);
				pos.originalContainer = curr;
				prev.push(pos);
			}				
			return prev;
		}, []);
		
		positionsPairs = 
		positions
		.reduce(function(coll, left, i) {
			positions
			.slice(i + 1, positions.length)
			.reduce(function(coll, right) {
				coll.push({ startPosition : left, endPosition : right});
				return coll;
			}, coll);
			return coll;
		}, []);
		
		// do it!
		positionsPairs.forEach(function(pair, i) {
			var s = utils.coordinatesPosToPos(pair.startPosition), 
				e = utils.coordinatesPosToPos(pair.endPosition);
		
			var extractRes = extract.extractContents(s, e, { top : editor, delete : true, splitRoot : editor } )
		
			paste.pasteHtmlAtPosWithParagraphs(extractRes, s, { top : editor });
			
			//consolelog(i)
			if(!(i % Math.floor(positionsPairs.length/100)))
				log(i + "% complete")
		})
		
		
		console.log(positionsPairs)
	}
	
	function testPaste(html) {
		var r = utils.getSelectionRange();
		
		paste.pasteHtmlAtPosWithParagraphs(html, { container : r.sc, offset : r.so }, { top : editor });
		
		//console.log(extract.extractContents({ container : r.sc, offset : r.so }, { container : r.ec, offset : r.eo }, { top : editor, delete : del, splitRoot : editor } ))
	}
	
	var logspace = document.querySelector('#logspace');


</script>


<body>
	<button onclick="testHasContent('backward')">&lt;hascontent</button>
	<button onclick="testHasContent('forward')">hascontent&gt;</button>
	<button onclick="testExtract(true)">cut</button>
	<button onclick="testExtract(false)">copy</button>
	<button onclick="testExtractAndPaste(false)">cut + paste</button>
	<br><br>
	<button onclick="testPaste('hanging<span class=\'paragraph\'>- hello paste -</span>')">paste (hanging start)</button>
	<button onclick="testPaste('<span class=\'paragraph\'>- paste - no hanging</span><span class=\'paragraph\'>just paragraphs -</span>')">paste (no hanging)</button>
	<button onclick="testPaste('<span class=\'paragraph\'>- hello paste -</span>hanging')">paste (hanging end)</button>
	<button onclick="testLoop()">cut-paste loop full test</button>
	<textarea id="log"></textarea>
	<div 
		id="editor" 
		contenteditable
	>01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30
a couple empty paragraphs<span class="paragraph"></span><span class="paragraph"></span><span class="paragraph">two consecutive</span><span class="paragraph">hello<br><br><br><br><br><br><br><br><br></span><span class="paragraph">paragraphs with empty paragraph between</span><span class="paragraph">two consecutive</span><span class="paragraph">paragraphs</span>
	<ir-gallery contenteditable="false"><img src="http://i00.i.aliimg.com/wsphoto/v0/1855197662_1/2015-%D7%A0%D7%99%D7%95-%D7%97%D7%99%D7%95%D7%AA-%D7%9E%D7%97%D7%9E%D7%93-%D7%9B%D7%9C%D7%91-%D7%A6%D7%A2%D7%A6%D7%95%D7%A2-%D7%9B%D7%93%D7%95%D7%A8-jin-mao-%D7%91%D7%99%D7%9E%D7%91%D7%95-%D7%93%D7%95%D7%91%D7%95%D7%9F-%D7%A1%D7%9E%D7%95%D7%99%D7%93-%D7%9E%D7%95%D7%A6%D7%A8%D7%99%D7%9D-%D7%9C%D7%9B%D7%9C%D7%91%D7%99%D7%9D-%D7%92%D7%95%D7%A8-%D7%A7%D7%98%D7%9F.jpg" style="display: inline-block; position: relative; width: 247px; height: 186.859px; transform: translate(0px, 0px);" width="247" height="186.859375"></ir-gallery><span class="paragraph">a paragraph with a CE just before it no space between</span>

	
	<span class="paragraph">01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30</span>
	<ir-gallery contenteditable="false"><img src="http://i00.i.aliimg.com/wsphoto/v0/1855197662_1/2015-%D7%A0%D7%99%D7%95-%D7%97%D7%99%D7%95%D7%AA-%D7%9E%D7%97%D7%9E%D7%93-%D7%9B%D7%9C%D7%91-%D7%A6%D7%A2%D7%A6%D7%95%D7%A2-%D7%9B%D7%93%D7%95%D7%A8-jin-mao-%D7%91%D7%99%D7%9E%D7%91%D7%95-%D7%93%D7%95%D7%91%D7%95%D7%9F-%D7%A1%D7%9E%D7%95%D7%99%D7%93-%D7%9E%D7%95%D7%A6%D7%A8%D7%99%D7%9D-%D7%9C%D7%9B%D7%9C%D7%91%D7%99%D7%9D-%D7%92%D7%95%D7%A8-%D7%A7%D7%98%D7%9F.jpg" style="display: inline-block; position: relative; width: 247px; height: 186.859px; transform: translate(0px, 0px);" width="247" height="186.859375"></ir-gallery>
		Some text <b><i>italic in bold</i>some bold</b> without paragraph ending with two brs<br><br><ir-gallery contenteditable="false" theme="blackfriday" style="display: inline-block;"><div class="caption-wrapper"><img src="https://storage17.tunefiles.com/files/thumbs/2014/07/26/1406397346ad30f-original-1.jpg" style="display: inline-block; position: relative; width: 218px; height: 166.313px; transform: translate(0px, 0px);" width="218" height="166.3125"><div class="caption" contenteditable="true">hi caption</div></div></ir-gallery><ir-gallery contenteditable="false"><img src="http://i00.i.aliimg.com/wsphoto/v0/1855197662_1/2015-%D7%A0%D7%99%D7%95-%D7%97%D7%99%D7%95%D7%AA-%D7%9E%D7%97%D7%9E%D7%93-%D7%9B%D7%9C%D7%91-%D7%A6%D7%A2%D7%A6%D7%95%D7%A2-%D7%9B%D7%93%D7%95%D7%A8-jin-mao-%D7%91%D7%99%D7%9E%D7%91%D7%95-%D7%93%D7%95%D7%91%D7%95%D7%9F-%D7%A1%D7%9E%D7%95%D7%99%D7%93-%D7%9E%D7%95%D7%A6%D7%A8%D7%99%D7%9D-%D7%9C%D7%9B%D7%9C%D7%91%D7%99%D7%9D-%D7%92%D7%95%D7%A8-%D7%A7%D7%98%D7%9F.jpg" style="display: inline-block; position: relative; width: 247px; height: 186.859px; transform: translate(0px, 0px);" width="247" height="186.859375"></ir-gallery>
		<span class="paragraph">a short paragraph a short paragraph a short paragraph <b>some bold in a short paragraph <i> some italic in bold in a short paragraph </i></b>a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph </span>
		<span class="paragraph"><ir-gallery contenteditable="false"><img src="http://i00.i.aliimg.com/wsphoto/v0/1855197662_1/2015-%D7%A0%D7%99%D7%95-%D7%97%D7%99%D7%95%D7%AA-%D7%9E%D7%97%D7%9E%D7%93-%D7%9B%D7%9C%D7%91-%D7%A6%D7%A2%D7%A6%D7%95%D7%A2-%D7%9B%D7%93%D7%95%D7%A8-jin-mao-%D7%91%D7%99%D7%9E%D7%91%D7%95-%D7%93%D7%95%D7%91%D7%95%D7%9F-%D7%A1%D7%9E%D7%95%D7%99%D7%93-%D7%9E%D7%95%D7%A6%D7%A8%D7%99%D7%9D-%D7%9C%D7%9B%D7%9C%D7%91%D7%99%D7%9D-%D7%92%D7%95%D7%A8-%D7%A7%D7%98%D7%9F.jpg" style="display: inline-block; position: relative; width: 247px; height: 186.859px; transform: translate(0px, 0px);" width="247" height="186.859375"></ir-gallery> a gallery immediately under a paragraph</span>

	<table border>
		<tr>
			<td>some</td>
			<td>tabled</td>
		</tr>
		<tr>
			<td>data</td>
			<td>here</td>
		</tr>
	</table>
	
	<span class="paragraph"><table border>
			<tr>
				<td>table inside</td>
				<td>paragraph</td>
			</tr>
		</table>
	</span>

	</div>

	
</body>

  
</html>
