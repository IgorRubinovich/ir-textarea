<!doctype html>
<!--
@license
Copyright (c) 2015 Igor Rubinovich <igor.rubinovich@gmail.com>. All rights reserved.
This code may only be used under the MIT license found at http://opensource.org/licenses/MIT
-->
<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="../../polymer/polymer.html">

  <link rel="import" href="../../ir-gallery/ir-gallery.html">

  <script src="../modules/utils.js"></script>
  <script src="../modules/caretRules.js"></script>
  <script src="../modules/extract.js"></script>
  <script src="../modules/paste.js"></script>
  <script src="../modules/wrap.js"></script>
  <script src="suites/wrap.js" async></script>

  <style>
	body { background-color : #eaeaea; padding : 25px }
	button { border-radius : 3px; min-width : 60px; height : 30px; font-size : 12px }
	.caret { display : inline-block; height : 1em; border : #fafafa 1px solid; padding : 4px; background : red; color : white; font-family : Arial; font-size : 10px }
	span.paragraph { display : block; border : blue 1px solid }
	#editor { 
		box-shadow : 0 0 3px lightblue; margin : 0 0 25px 0; padding : 25px; background-color : white 
		white-space: pre-wrap;       /* css-3 */
		white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
		white-space: -pre-wrap;      /* Opera 4-6 */
		white-space: -o-pre-wrap;    /* Opera 7 */
		word-wrap: break-word;       /* Internet Explorer 5.5+ */
	}
	#elclone { max-height : 100px; overflow : hidden; }
	.testWrapper { border : 1px solid red; margin : 5px }
  </style>  
</head>
<body>
	<button onclick="testWrap()">wrap</button>
	<button onclick="testWrapChildrenOf()">wrap children</button>
	<button onclick="testSplitNodeIntoWrapGroups()">split node into groups</button>
	<div>
		<button onclick="testWrapContents()">wrap contents with</button>
		<button onclick="testWrapSelection('b')"><b>b</b></button>
		<button onclick="testWrapSelection('i')"><i>i</i></button>
		<button onclick="testWrapSelection('u')"><u>u</u></button>
		<button onclick="testWrapSelection('s')"><s>s</s></button>
		<button onclick="testWrapSelection('span style=\'background-color : yellow\'')">yellow</button>
		<button onclick="testWrapSelection('span style=\'background-color : lightgreen\'')">green</button>
		<button onclick="testWrapSelection('span style=\'background-color : lightblue\'')">blue</button>
		<button onclick="resetHTML()">reset html</button>
		<textarea type=text id="wrapper" rows=1>&lt;i&gt;&lt;/i&gt;</textarea>
		<hr>
		<button onclick="testWrapBlockLevel('h1')">H1</button>		
		<button onclick="testWrapBlockLevel('h2')">H2</button>		
		<button onclick="testWrapBlockLevel('h3')">H3</button>		
		<button onclick="testWrapBlockLevel('span class=paragraph')">P</button>		
		<hr>
		Save a successful test
		<input type=text id="testName" rows=1 placeholder="test name here">
		<button onclick="saveTest()">save</button>
		<button id="runTests" onclick="runTests()">run</button>
		<textarea type=text id="testsLog" rows=1 placeholder="test name here"></textarea>
	</div>
	<script>
		var editor, 
			w = window.ir.textarea.wrap,
			utils = window.ir.textarea.utils;

		var originalHTML, 
			last = {}, 
			testsLog, 
			testsLogArr = [], 
			caretPos, 
			testName,
			runTestsButton;
		
		window.addEventListener('DOMContentLoaded', function () {
			editor = document.getElementById('editor');
			
			testsLog = document.getElementById('testsLog');
			runTestsButton = document.getElementById('runTests');
			
			testsLogArr = ir.textarea.tests.wrap;
			
			testsLog.value = formatTests(testsLogArr);
			
			testName = document.getElementById('testName');
			originalHTML = Polymer.dom(editor).innerHTML;
			document.addEventListener('keydown', function(e) { 
				if(e.altKey && e.keyCode == 82) resetHTML(); 
				if(e.altKey && e.keyCode == 69) testWrapSelection('span style=\'background-color : yellow\''); 
			})
		});
		

		
		function runTests() {
			var testsData = JSON.parse(testsLog.value),
				results = [], i = 0, total = testsData.length;
			
			runTestsButton.disabled = true;
			
			var runTest = function(td)
			{
				if(!testsData.length)
				{	
					runTestsButton.disabled = false; 
					return console[navigator.userAgent.match("Edge|MSIE") ? "log" : "table"](results); //.map(function(n) { return n.name + " " + (n.passed ? "PASS" : "FAIL") }).join("\n"));
				}
				
				var td = testsData.shift();
				console.log("Test", ++i, '/', total, ': ', td.name)
				
				editor.innerHTML = td.originalHTML;
				this[td.command].apply(this, td.arguments);
				
				results.push({ 
								command : td.command.replace(/test\s*/, '').replace(/([A-Z])/g, " $1").trim(), 
								name : td.name, 
								passed : Polymer.dom(editor).innerHTML == td.resultHTML 
							})

				setTimeout(runTest, 500);
			}

			runTest();
		}
		
		function saveTest() {
			if(!testName.value)
				return alert('must enter a test name')

			testsLogArr.push({ 
							name : testName.value, 
							command : last.command,
							arguments : last.arguments,
							originalHTML : last.originalHTML, 
							resultHTML : last.resultHTML
						});
							
			testsLog.value = formatTests(testsLogArr);
		}
		
		function formatTests(arr) {
			return JSON.stringify(arr, null, "\t");
		}
		
		function testWrap() {
			var d;
			
			var w = window.ir.textarea.wrap;
			var utils = window.ir.textarea.utils;
			var wrapper = w.parseWrapper("<div><span id='insertionPoint'></span></div>")	
			
			wrapper.wrapAppend(document.body.firstChild);
			
			console.log(wrapper);
		}
		function testWrapChildrenOf() {
			var utils = window.ir.textarea.utils;
			
			w.wrapChildrenOfWith(editor, "<h3>Wrapped!</h3><div class='testWrapper'><span id='insertionPoint'></span></div>");
		}
		
		function testWrapContents() {
			w.wrapContents(editor, "<i><span id='insertionPoint'></span></i>", editor);
		}
		
		function testSplitNodeIntoWrapGroups() {
			var groups = w.splitNodeIntoWrapGroups(editor);
			intToRandom.reset();
			var visited = [];
			groups.forEach(function(g, i) {
				var c = intToRandom(i);
				
				if(visited.indexOf(g[0]) > -1)
					throw new Error("visited: " + g[0].toString());

				visited.push(g[0]);
				
				// intentionally slowed down
				setTimeout(function() {
					Polymer.dom(g[0]).parentNode.style.backgroundColor = c;
				}, 50*i);
			})
		}

		function testWrapBlockLevel(tag, startPosCoords, endPosCoords) {
			var r = utils.getSelectionRange(), s, e;

			s = {
					container : r.startContainer,
					offset : r.startOffset
				}
			e = {
					container : r.endContainer,
					offset : r.endOffset
				}

			w.wrapRangeBlockLevel({ startPosition : s, endPosition : e }, tag, editor);
				
		}
		
		function testWrapSelection(tag, startPosCoords, endPosCoords) {
			var s, e, r;

			if(startPosCoords && endPosCoords)
			{ 
				s = startPosCoords && utils.coordinatesPosToPos(startPosCoords);
				e = endPosCoords && utils.coordinatesPosToPos(endPosCoords);
			}
			else
			{
				r = utils.getSelectionRange();
				
				s = {
						container : r.startContainer,
						offset : r.startOffset
					}
				e = {
						container : r.endContainer,
						offset : r.endOffset
					}
			}
			
			last = {
				command : "testWrapSelection",
				arguments : [tag, utils.posToCoordinatesPos(s), utils.posToCoordinatesPos(e)],
				originalHTML : Polymer.dom(editor).innerHTML,
			}

			var res = w.wrapWithAttributes({ startPosition : s, endPosition : e}, tag);
			// console.log(res);
			utils.setCaretAt(res.startPosition.container, res.startPosition.offset, res.endPosition.container, res.endPosition.offset);
			
			last.resultHTML = Polymer.dom(editor).innerHTML;
        }	
		
		function resetHTML()
		{
			Polymer.dom(editor).innerHTML = originalHTML;
		}
		
		var intToRandom = (function() {
			var cache = {};
			var random = function() { return Math.floor(Math.random()*255); }
			var f = function(i) {
				if(!cache[i])
					cache[i] = "rgb(" + random() + "," + random() + ',' + random() + ")";
			
				return cache[i];
			}
			
			f.reset = function() {
				cache = {};
			}
			
			return f;
		})()
		
	</script>

	<div 
		id="editor" 
		contenteditable
	><span class="paragraph">01. paragraphs with empty paragraph between</span><span class="paragraph">02. two consecutive</span><span class="paragraph">03. paragraphs</span>some normal text, an <i>italic block</i><b>and a bold block</b> enter a bar
	<ir-gallery contenteditable="false" theme="blackfriday" style="display: inline-block;"><div class="caption-wrapper"><img src="http://loremflickr.com/300/200/proverb" style="display: inline-block; position: relative; transform: translate(0px, 0px);"><div class="caption" contenteditable="true">hi caption</div></div></ir-gallery><table border>
		<tr>
			<td>some</td>
			<td>tabled</td>
		</tr>
		<tr>
			<td>data</td>
			<td>here</td>
		</tr>
	</table>bare text<ir-gallery contenteditable="false"><img  src="http://loremflickr.com/300/200/prague,texas" style="display: inline-block; position: relative; width: 247px; height: 186.859px; transform: translate(0px, 0px);" width="247" height="186.859375"></ir-gallery><span class="paragraph">a paragraph with a CE just before it no space between</span>
	
a couple empty paragraphs<span class="paragraph"></span><span class="paragraph"></span><span class="paragraph">two consecutive</span><span class="paragraph">hello<br><br><br><br><br><br><br><br><br></span><span class="paragraph">01. paragraphs with empty paragraph between</span><span class="paragraph">02. two consecutive</span><span class="paragraph">03. paragraphs</span>
	<ir-gallery contenteditable="false"><img src="http://loremflickr.com/300/200/math,music,space,rainbow" " style="display: inline-block; position: relative; width: 247px; height: 186.859px; transform: translate(0px, 0px);" width="247" height="186.859375"></ir-gallery><span class="paragraph">a paragraph with a CE just before it no space between</span>

	
	
	<ir-gallery contenteditable="false"><img src="http://loremflickr.com/300/200/czech,texas,sea,sky,rainbow"></ir-gallery>
		Some text <b><i>italic in bold</i>some bold</b> without paragraph ending with two brs<br><br><ir-gallery contenteditable="false" theme="blackfriday" style="display: inline-block;"><div class="caption-wrapper"><img src="http://loremflickr.com/300/200/czech,texas,sea,sky,rainbow" style="display: inline-block; position: relative; width: 218px; height: 166.313px; transform: translate(0px, 0px);" width="218" height="166.3125"><div class="caption" contenteditable="true">hi caption</div></div></ir-gallery><ir-gallery contenteditable="false"><img src="http://loremflickr.com/300/200/czech,texas,sea,sky,rainbow"></ir-gallery>
		<span class="paragraph">a short paragraph a short paragraph a short paragraph <b>some bold in a short paragraph <i> some italic in bold in a short paragraph </i></b>a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph a short paragraph </span>
		<span class="paragraph"><ir-gallery contenteditable="false"><img src="http://loremflickr.com/300/200/czech,texas,sea,sky,rainbow"></ir-gallery> a gallery immediately under a paragraph</span>

	<table border>
		<tr>
			<td>some</td>
			<td>tabled</td>
		</tr>
		<tr>
			<td>data</td>
			<td>here</td>
		</tr>
	</table>
	
	<span class="paragraph"><table border>
			<tr>
				<td>table inside</td>
				<td>paragraph</td>
			</tr>
		</table>
	</span>

	</div>
</body>
</html>
